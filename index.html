<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Private Game Room</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #1a1a1a 0%, #2d2d2d 100%);
            color: #ffffff;
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            color: #ff6b6b;
        }

        .game-section {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 20px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .join-form {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .join-form input, .join-form button {
            padding: 12px 20px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
        }

        .join-form input {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.3);
            flex: 1;
            min-width: 200px;
        }

        .join-form input::placeholder {
            color: rgba(255, 255, 255, 0.7);
        }

        .btn {
            background: linear-gradient(135deg, #ff6b6b, #ee5a52);
            color: white;
            cursor: pointer;
            transition: all 0.3s ease;
            border: none;
            border-radius: 8px;
            padding: 12px 24px;
            font-size: 16px;
        }

        .btn:hover {
            background: linear-gradient(135deg, #ee5a52, #ff6b6b);
            transform: translateY(-2px);
        }

        .btn:disabled {
            background: #666;
            cursor: not-allowed;
            transform: none;
        }

        .btn-secondary {
            background: linear-gradient(135deg, #4ecdc4, #44a08d);
        }

        .btn-secondary:hover {
            background: linear-gradient(135deg, #44a08d, #4ecdc4);
        }

        .game-info {
            text-align: center;
            margin-bottom: 20px;
            padding: 15px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
        }

        .game-code {
            font-size: 2rem;
            font-weight: bold;
            color: #4ecdc4;
            margin: 10px 0;
            letter-spacing: 3px;
        }

        .players-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .player-card {
            background: rgba(255, 255, 255, 0.15);
            border-radius: 10px;
            padding: 15px;
            border: 2px solid transparent;
            transition: all 0.3s ease;
            position: relative;
        }

        .player-card.czar {
            border-color: #ffd700;
            background: rgba(255, 215, 0, 0.2);
        }

        .player-card.host {
            border-color: #ff6b6b;
        }

        .player-name {
            font-weight: bold;
            font-size: 18px;
            margin-bottom: 5px;
        }

        .player-score {
            color: #4ecdc4;
            font-size: 24px;
            font-weight: bold;
        }

        .black-card {
            background: #1a1a1a;
            border: 2px solid #333;
            border-radius: 12px;
            padding: 20px;
            margin: 10px;
            font-size: 18px;
            font-weight: bold;
            min-height: 150px;
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .black-card:hover {
            border-color: #ff6b6b;
            transform: translateY(-2px);
        }

        .black-card.selected {
            border-color: #ffd700;
            background: rgba(255, 215, 0, 0.1);
        }

        .active-black-card {
            background: #1a1a1a;
            border: 2px solid #ffd700;
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 20px;
            font-size: 20px;
            font-weight: bold;
            text-align: center;
            min-height: 120px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .white-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .white-card {
            background: #f8f8f8;
            color: #333;
            border: 2px solid #ddd;
            border-radius: 10px;
            padding: 15px;
            cursor: pointer;
            transition: all 0.3s ease;
            min-height: 100px;
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
            font-size: 16px;
        }

        .white-card:hover {
            border-color: #4ecdc4;
            transform: translateY(-2px);
        }

        .white-card.selected {
            border-color: #ff6b6b;
            background: #ffe6e6;
        }

        .custom-answer-input {
            width: 100%;
            padding: 15px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 10px;
            background: rgba(255, 255, 255, 0.1);
            color: white;
            font-size: 16px;
            margin-bottom: 10px;
        }

        .custom-answer-input::placeholder {
            color: rgba(255, 255, 255, 0.6);
        }

        .submissions-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .submission-card {
            background: #f8f8f8;
            color: #333;
            border: 2px solid #ddd;
            border-radius: 10px;
            padding: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            min-height: 120px;
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
            font-size: 16px;
        }

        .submission-card:hover {
            border-color: #4ecdc4;
            transform: translateY(-2px);
        }

        .submission-card.selected {
            border-color: #ff6b6b;
            background: #ffe6e6;
        }

        .submission-card.winner {
            border-color: #ffd700;
            background: #fffacd;
        }

        .actions {
            display: flex;
            gap: 15px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .hidden {
            display: none;
        }

        .round-info {
            text-align: center;
            font-size: 20px;
            color: #4ecdc4;
            margin-bottom: 15px;
        }

        .game-status {
            text-align: center;
            font-size: 18px;
            margin-bottom: 20px;
            padding: 15px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
        }

        .waiting-indicator {
            text-align: center;
            padding: 20px;
            font-style: italic;
            color: #aaa;
        }

        @media (max-width: 768px) {
            .header h1 {
                font-size: 2rem;
            }
            
            .join-form {
                flex-direction: column;
            }
            
            .join-form input {
                min-width: auto;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ðŸŽ² Private Game Room</h1>
            <p>A card game for friends who aren't easily offended</p>
        </div>

        <!-- Start/Join Game Section -->
        <div id="mainSection" class="game-section">
            <h2 style="text-align: center; margin-bottom: 20px;">Join or Create Game</h2>
            <div class="join-form">
                <input type="text" id="playerName" placeholder="Enter your name" maxlength="20">
                <input type="text" id="gameCode" placeholder="Game code (leave empty to create)" maxlength="6">
                <button class="btn" onclick="joinOrCreateGame()">Join/Create Game</button>
            </div>
        </div>

        <!-- Game Info Section -->
        <div id="gameInfoSection" class="game-section hidden">
            <div class="game-info">
                <h3>Game Code:</h3>
                <div class="game-code" id="displayGameCode"></div>
                <p>Share this code with friends to let them join!</p>
            </div>
        </div>

        <!-- Players List -->
        <div id="playersSection" class="game-section hidden">
            <h2 style="text-align: center; margin-bottom: 20px;">Players</h2>
            <div id="playersList" class="players-list">
                <!-- Players will be populated here -->
            </div>
            <div id="hostControls" class="actions hidden">
                <button class="btn" onclick="startGame()">Start Game</button>
            </div>
        </div>

        <!-- Game Status -->
        <div id="gameStatus" class="game-status hidden">
            Waiting for game to start...
        </div>

        <!-- Round Info -->
        <div id="roundInfo" class="round-info hidden">
            <!-- Round information will be displayed here -->
        </div>

        <!-- Czar Black Card Selection -->
        <div id="czarSection" class="game-section hidden">
            <h2 style="text-align: center; margin-bottom: 20px;">Choose a Black Card</h2>
            <div id="blackCardOptions" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 15px;">
                <!-- Black card options will be populated here -->
            </div>
            <div class="actions">
                <button class="btn btn-secondary" onclick="redrawBlackCards()">Redraw Cards</button>
                <button id="selectBlackCardBtn" class="btn" onclick="selectBlackCard()" disabled>Select This Card</button>
            </div>
        </div>

        <!-- Active Round -->
        <div id="roundSection" class="game-section hidden">
            <div id="activeBlackCard" class="active-black-card">
                <!-- Active black card will be displayed here -->
            </div>

            <!-- Player Hand -->
            <div id="playerHand">
                <h3 style="margin-bottom: 15px;">Your White Cards:</h3>
                <div id="whiteCards" class="white-cards">
                    <!-- Player's white cards will be populated here -->
                </div>
            </div>

            <!-- Custom Answer Section -->
            <div style="margin-bottom: 20px;">
                <h3 style="margin-bottom: 10px;">Or submit a custom answer:</h3>
                <input type="text" id="customAnswerInput" class="custom-answer-input" placeholder="Type your own hilarious answer..." maxlength="100">
            </div>

            <div class="actions">
                <button class="btn btn-secondary" onclick="redrawHand()">Redraw All Cards</button>
                <button id="submitAnswerBtn" class="btn" onclick="submitAnswer()" disabled>Submit Answer</button>
            </div>
        </div>

        <!-- Submissions and Judging -->
        <div id="submissionsSection" class="game-section hidden">
            <div id="activeBlackCardJudge" class="active-black-card">
                <!-- Active black card for judging will be displayed here -->
            </div>
            
            <div class="waiting-indicator" id="waitingIndicator">
                <!-- Waiting message will be shown here -->
            </div>

            <div>
                <h3 style="text-align: center; margin-bottom: 20px;">Submitted Answers</h3>
                <div id="submissionsGrid" class="submissions-grid">
                    <!-- Submitted answers will be populated here -->
                </div>
            </div>

            <div class="actions" id="judgeActions">
                <button id="selectWinnerBtn" class="btn" onclick="selectWinner()" disabled>Choose Winner</button>
            </div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>

    <script>
        // Firebase Configuration - You'll need to replace this with your own config
        const firebaseConfig = {
            apiKey: "AIzaSyA7hz07OZNNNLPKlQFw1j5vEiewwPOOUOQ",
            authDomain: "saturday-night-cards.firebaseapp.com",
            databaseURL: "https://saturday-night-cards-default-rtdb.firebaseio.com",
            projectId: "saturday-night-cards",
            storageBucket: "saturday-night-cards.firebasestorage.app",
            messagingSenderId: "216085215949",
            appId: "1:216085215949:web:1a08c0096000713518c784",
            measurementId: "G-2FDBQ8VWYL"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        // Game state
        let currentGame = null;
        let currentPlayer = {
            id: null,
            name: '',
            isHost: false
        };
        let selectedCardIndex = null;
        let selectedSubmissionIndex = null;

        // Default card decks
        const defaultBlackCards = [
            "___: kid tested, mother approved.",
            "___? There's an app for that.",
            "What's the next Happy Meal toy?",
            "In his new self-produced album, Kanye West raps over the sounds of ___.",
            "What ended my last relationship?",
            "I drink to forget ___.",
            "What's that sound?",
            "What's the most emo?",
            "Instead of coal, Santa now gives the bad children ___.",
            "What gives me uncontrollable gas?"
        ];

        const defaultWhiteCards = [
            "A mime having a stroke",
            "The Big Bang",
            "Getting so angry you pop a boner",
            "Vigorous jazz hands",
            "A windmill full of corpses",
            "Swooping",
            "The invisible hand",
            "A sassy black woman",
            "Abstinence",
            "Adderall",
            "My genitals",
            "Racially-biased SAT questions",
            "The Three-Fifths compromise",
            "Take-backsies",
            "My collection of high-tech sex toys",
            "Throwing a virgin into a volcano",
            "Bling",
            "Poor life choices",
            "Powerful thighs",
            "The South"
        ];

        // Utility functions
        function generateId() {
            return Math.random().toString(36).substr(2, 9);
        }

        function generateGameCode() {
            return Math.random().toString(36).substr(2, 6).toUpperCase();
        }

        function shuffleArray(array) {
            const shuffled = [...array];
            for (let i = shuffled.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
            }
            return shuffled;
        }

        function getRandomCards(deck, count) {
            return shuffleArray(deck).slice(0, count);
        }

        // UI Management
        function showSection(sectionId) {
            document.querySelectorAll('.game-section, #gameStatus, #roundInfo').forEach(section => {
                section.classList.add('hidden');
            });
            const section = document.getElementById(sectionId);
            if (section) section.classList.remove('hidden');
        }

        function updateGameStatus(message) {
            const statusEl = document.getElementById('gameStatus');
            statusEl.textContent = message;
            statusEl.classList.remove('hidden');
        }

        function updatePlayersDisplay(gameData) {
            const playersList = document.getElementById('playersList');
            playersList.innerHTML = '';

            if (!gameData.players) return;

            Object.values(gameData.players).forEach(player => {
                const playerDiv = document.createElement('div');
                playerDiv.className = 'player-card';
                
                if (player.id === gameData.hostId) {
                    playerDiv.classList.add('host');
                }
                if (player.id === gameData.czarId) {
                    playerDiv.classList.add('czar');
                }

                playerDiv.innerHTML = `
                    <div class="player-name">
                        ${player.name}
                        ${player.id === gameData.hostId ? ' ðŸ‘‘' : ''}
                        ${player.id === gameData.czarId ? ' ðŸŽ©' : ''}
                    </div>
                    <div class="player-score">Score: ${player.score || 0}</div>
                `;
                playersList.appendChild(playerDiv);
            });
        }

        // Game Logic
        async function joinOrCreateGame() {
            const nameInput = document.getElementById('playerName');
            const codeInput = document.getElementById('gameCode');
            const name = nameInput.value.trim();
            const code = codeInput.value.trim().toUpperCase();

            if (!name) {
                alert('Please enter your name');
                return;
            }

            currentPlayer.name = name;
            currentPlayer.id = generateId();

            if (code) {
                // Join existing game
                await joinGame(code);
            } else {
                // Create new game
                await createGame();
            }
        }

        async function createGame() {
            const gameCode = generateGameCode();
            currentPlayer.isHost = true;

            const gameData = {
                code: gameCode,
                hostId: currentPlayer.id,
                phase: 'waiting',
                players: {
                    [currentPlayer.id]: {
                        id: currentPlayer.id,
                        name: currentPlayer.name,
                        score: 0,
                        hand: []
                    }
                },
                blackCards: defaultBlackCards,
                whiteCards: defaultWhiteCards,
                round: 0,
                maxRounds: 10,
                whiteCardCount: 7,
                createdAt: Date.now()
            };

            try {
                await database.ref(`games/${gameCode}`).set(gameData);
                currentGame = gameCode;
                setupGameListener(gameCode);
                showGameLobby(gameCode);
            } catch (error) {
                alert('Error creating game: ' + error.message);
            }
        }

        async function joinGame(gameCode) {
            try {
                const gameSnapshot = await database.ref(`games/${gameCode}`).once('value');
                const gameData = gameSnapshot.val();

                if (!gameData) {
                    alert('Game not found. Please check the code.');
                    return;
                }

                if (gameData.phase !== 'waiting') {
                    alert('This game has already started.');
                    return;
                }

                // Add player to game
                await database.ref(`games/${gameCode}/players/${currentPlayer.id}`).set({
                    id: currentPlayer.id,
                    name: currentPlayer.name,
                    score: 0,
                    hand: []
                });

                currentGame = gameCode;
                setupGameListener(gameCode);
                showGameLobby(gameCode);
            } catch (error) {
                alert('Error joining game: ' + error.message);
            }
        }

        function setupGameListener(gameCode) {
            database.ref(`games/${gameCode}`).on('value', (snapshot) => {
                const gameData = snapshot.val();
                if (!gameData) return;

                updateGameDisplay(gameData);
            });
        }

        function updateGameDisplay(gameData) {
            updatePlayersDisplay(gameData);

            switch (gameData.phase) {
                case 'waiting':
                    showWaitingPhase(gameData);
                    break;
                case 'czar_selecting':
                    showCzarSelectionPhase(gameData);
                    break;
                case 'players_submitting':
                    showPlayerSubmissionPhase(gameData);
                    break;
                case 'judging':
                    showJudgingPhase(gameData);
                    break;
                case 'round_end':
                    showRoundEndPhase(gameData);
                    break;
                case 'game_end':
                    showGameEndPhase(gameData);
                    break;
            }
        }

        function showGameLobby(gameCode) {
            document.getElementById('displayGameCode').textContent = gameCode;
            document.getElementById('mainSection').classList.add('hidden');
            document.getElementById('gameInfoSection').classList.remove('hidden');
            document.getElementById('playersSection').classList.remove('hidden');
            
            if (currentPlayer.isHost) {
                document.getElementById('hostControls').classList.remove('hidden');
            }
        }

        function showWaitingPhase(gameData) {
            updateGameStatus('Waiting for players to join...');
        }

        async function startGame() {
            if (!currentPlayer.isHost) return;

            const gameData = (await database.ref(`games/${currentGame}`).once('value')).val();
            const playerCount = Object.keys(gameData.players).length;

            if (playerCount < 3) {
                alert('Need at least 3 players to start');
                return;
            }

            // Deal initial hands and start first round
            const updates = {};
            const playerIds = Object.keys(gameData.players);
            
            playerIds.forEach(playerId => {
                const hand = getRandomCards(gameData.whiteCards, gameData.whiteCardCount);
                updates[`players/${playerId}/hand`] = hand;
            });

            updates.phase = 'czar_selecting';
            updates.round = 1;
            updates.czarId = gameData.hostId;
            updates.blackCardOptions = getRandomCards(gameData.blackCards, 3);

            await database.ref(`games/${currentGame}`).update(updates);
        }

        function showCzarSelectionPhase(gameData) {
            document.getElementById('hostControls').classList.add('hidden');
            updateGameStatus(`Round ${gameData.round} of ${gameData.maxRounds}`);
            
            const roundInfoEl = document.getElementById('roundInfo');
            const czar = gameData.players[gameData.czarId];
            roundInfoEl.innerHTML = `Card Czar: ${czar ? czar.name : 'Unknown'}`;
            roundInfoEl.classList.remove('hidden');

            if (currentPlayer.id === gameData.czarId) {
                showSection('czarSection');
                displayBlackCardOptions(gameData.blackCardOptions);
                updateGameStatus('You are the Card Czar! Choose a black card.');
            } else {
                updateGameStatus('Waiting for Card Czar to select a black card...');
            }
        }

        function displayBlackCardOptions(options) {
            const container = document.getElementById('blackCardOptions');
            container.innerHTML = '';

            options.forEach((card, index) => {
                const cardDiv = document.createElement('div');
                cardDiv.className = 'black-card';
                cardDiv.textContent = card;
                cardDiv.onclick = () => selectBlackCardOption(index);
                container.appendChild(cardDiv);
            });
        }

        function selectBlackCardOption(index) {
            selectedCardIndex = index;
            
            document.querySelectorAll('#blackCardOptions .black-card').forEach((card, i) => {
                card.classList.toggle('selected', i === index);
            });
            
            document.getElementById('selectBlackCardBtn').disabled = false;
        }

        async function redrawBlackCards() {
            if (currentPlayer.id !== (await getCurrentGameData()).czarId) return;

            const gameData = await getCurrentGameData();
            const newOptions = getRandomCards(gameData.blackCards, 3);
            
            await database.ref(`games/${currentGame}/blackCardOptions`).set(newOptions);
        }

        async function selectBlackCard() {
            if (selectedCardIndex === null) return;

            const gameData = await getCurrentGameData();
            const selectedCard = gameData.blackCardOptions[selectedCardIndex];

            const updates = {
                phase: 'players_submitting',
                activeBlackCard: selectedCard,
                submissions: {},
                submittedPlayers: {}
            };

            await database.ref(`games/${currentGame}`).update(updates);
        }

        function showPlayerSubmissionPhase(gameData) {
            document.getElementById('activeBlackCard').textContent = gameData.activeBlackCard;
            document.getElementById('activeBlackCardJudge').textContent = gameData.activeBlackCard;

            if (currentPlayer.id === gameData.czarId) {
                showSection('submissionsSection');
                updateWaitingIndicator(gameData);
                updateGameStatus('Waiting for players to submit their answers...');
            } else {
                showSection('roundSection');
                displayPlayerHand(gameData.players[currentPlayer.id].hand);
                updateGameStatus('Choose a white card or type a custom answer, then submit!');
            }
        }

        function displayPlayerHand(hand) {
            const container = document.getElementById('whiteCards');
            container.innerHTML = '';

            hand.forEach((card, index) => {
                const cardDiv = document.createElement('div');
                cardDiv.className = 'white-card';
                cardDiv.textContent = card;
                cardDiv.onclick = () => selectWhiteCard(index);
                container.appendChild(cardDiv);
            });

            updateSubmitButton();
        }

        function selectWhiteCard(index) {
            selectedCardIndex = index;
            
            document.querySelectorAll('#whiteCards .white-card').forEach((card, i) => {
                card.classList.toggle('selected', i === index);
            });
            
            document.getElementById('customAnswerInput').value = '';
            updateSubmitButton();
        }

        function updateSubmitButton() {
            const customAnswer = document.getElementById('customAnswerInput').value.trim();
            const hasSelection = selectedCardIndex !== null || customAnswer;
            document.getElementById('submitAnswerBtn').disabled = !hasSelection;
        }

        async function submitAnswer() {
            const customAnswer = document.getElementById('customAnswerInput').value.trim();
            let answer;
            let isCustom = false;

            if (customAnswer) {
                answer = customAnswer;
                isCustom = true;
            } else if (selectedCardIndex !== null) {
                const gameData = await getCurrentGameData();
                const playerHand = gameData.players[currentPlayer.id].hand;
                answer = playerHand[selectedCardIndex];
                
                // Remove card from hand and add new one
                const newHand = [...playerHand];
                newHand.splice(selectedCardIndex, 1);
                const availableCards = gameData.whiteCards.filter(card => !newHand.includes(card));
                if (availableCards.length > 0) {
                    newHand.push(getRandomCards(availableCards, 1)[0]);
                }
                
                await database.ref(`games/${currentGame}/players/${currentPlayer.id}/hand`).set(newHand);
            } else {
                return;
            }

            const submissionId = generateId();
            const updates = {};
            updates[`submissions/${submissionId}`] = {
                playerId: currentPlayer.id,
                answer: answer,
                isCustom: isCustom
            };
            updates[`submittedPlayers/${currentPlayer.id}`] = true;

            await database.ref(`games/${currentGame}`).update(updates);

            selectedCardIndex = null;
            document.getElementById('customAnswerInput').value = '';
            updateGameStatus('Answer submitted! Waiting for other players...');

            // Check if all players have submitted
            checkAllSubmitted();
        }

        async function checkAllSubmitted() {
            const gameData = await getCurrentGameData();
            const playerIds = Object.keys(gameData.players).filter(id => id !== gameData.czarId);
            const submittedIds = Object.keys(gameData.submittedPlayers || {});

            if (playerIds.length === submittedIds.length) {
                await database.ref(`games/${currentGame}/phase`).set('judging');
            }
        }

        function showJudgingPhase(gameData) {
            showSection('submissionsSection');
            updateSubmissionsDisplay(gameData);
            
            if (currentPlayer.id === gameData.czarId) {
                updateGameStatus('Choose the winning answer!');
                document.getElementById('judgeActions').style.display = 'flex';
            } else {
                updateGameStatus('Card Czar is choosing the winner...');
                document.getElementById('judgeActions').style.display = 'none';
            }
        }

        function updateSubmissionsDisplay(gameData) {
            const container = document.getElementById('submissionsGrid');
            container.innerHTML = '';

            if (!gameData.submissions) return;

            const submissions = Object.values(gameData.submissions);
            const shuffledSubmissions = shuffleArray(submissions);

            shuffledSubmissions.forEach((submission, index) => {
                const cardDiv = document.createElement('div');
                cardDiv.className = 'submission-card';
                cardDiv.textContent = submission.answer;
                
                if (currentPlayer.id === gameData.czarId) {
                    cardDiv.onclick = () => selectSubmission(index, submission);
                }
                
                container.appendChild(cardDiv);
            });
        }

        function selectSubmission(index, submission) {
            selectedSubmissionIndex = index;
            
            document.querySelectorAll('#submissionsGrid .submission-card').forEach((card, i) => {
                card.classList.toggle('selected', i === index);
            });
            
            document.getElementById('selectWinnerBtn').disabled = false;
            window.selectedSubmission = submission;
        }

        async function selectWinner() {
            if (!window.selectedSubmission) return;

            const gameData = await getCurrentGameData();
            const winner = gameData.players[window.selectedSubmission.playerId];
            
            if (winner) {
                const updates = {
                    phase: 'round_end',
                    lastWinner: {
                        playerId: winner.id,
                        name: winner.name,
                        answer: window.selectedSubmission.answer
                    }
                };
                
                updates[`players/${winner.id}/score`] = (winner.score || 0) + 1;

                await database.ref(`games/${currentGame}`).update(updates);
            }
        }

        function showRoundEndPhase(gameData) {
            if (gameData.lastWinner) {
                updateGameStatus(`ðŸŽ‰ ${gameData.lastWinner.name} wins this round with: "${gameData.lastWinner.answer}"`);
                
                // Highlight winning submission
                document.querySelectorAll('#submissionsGrid .submission-card').forEach(card => {
                    if (card.textContent === gameData.lastWinner.answer) {
                        card.classList.add('winner');
                    }
                });
            }

            setTimeout(() => {
                nextRound();
            }, 3000);
        }

        async function nextRound() {
            if (!currentPlayer.isHost) return;

            const gameData = await getCurrentGameData();
            const newRound = gameData.round + 1;

            if (newRound > gameData.maxRounds) {
                await database.ref(`games/${currentGame}/phase`).set('game_end');
                return;
            }

            const updates = {
                phase: 'czar_selecting',
                round: newRound,
                czarId: gameData.lastWinner ? gameData.lastWinner.playerId : gameData.hostId,
                blackCardOptions: getRandomCards(gameData.blackCards, 3),
                activeBlackCard: null,
                submissions: null,
                submittedPlayers: null,
                lastWinner: null
            };

            await database.ref(`games/${currentGame}`).update(updates);
        }

        function showGameEndPhase(gameData) {
            const players = Object.values(gameData.players);
            const maxScore = Math.max(...players.map(p => p.score || 0));
            const winners = players.filter(p => (p.score || 0) === maxScore);
            
            let message;
            if (winners.length === 1) {
                message = `ðŸ† Game Over! ${winners[0].name} wins with ${maxScore} points!`;
            } else {
                const winnerNames = winners.map(w => w.name).join(' and ');
                message = `ðŸ† Game Over! It's a tie between ${winnerNames} with ${maxScore} points each!`;
            }
            
            updateGameStatus(message);
            document.getElementById('roundInfo').classList.add('hidden');
        }

        function updateWaitingIndicator(gameData) {
            const indicator = document.getElementById('waitingIndicator');
            const playerIds = Object.keys(gameData.players).filter(id => id !== gameData.czarId);
            const submittedIds = Object.keys(gameData.submittedPlayers || {});
            const pendingIds = playerIds.filter(id => !submittedIds.includes(id));
            
            if (pendingIds.length > 0) {
                const pendingNames = pendingIds.map(id => gameData.players[id].name);
                indicator.textContent = `Waiting for: ${pendingNames.join(', ')}`;
                indicator.style.display = 'block';
            } else {
                indicator.style.display = 'none';
            }
        }

        async function redrawHand() {
            const gameData = await getCurrentGameData();
            const playerHand = gameData.players[currentPlayer.id].hand;
            const newHand = getRandomCards(gameData.whiteCards, gameData.whiteCardCount);
            
            await database.ref(`games/${currentGame}/players/${currentPlayer.id}/hand`).set(newHand);
        }

        async function getCurrentGameData() {
            const snapshot = await database.ref(`games/${currentGame}`).once('value');
            return snapshot.val();
        }

        // Event Listeners
        document.getElementById('playerName').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                joinOrCreateGame();
            }
        });

        document.getElementById('gameCode').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                joinOrCreateGame();
            }
        });

        document.getElementById('customAnswerInput').addEventListener('input', function(e) {
            selectedCardIndex = null;
            document.querySelectorAll('#whiteCards .white-card').forEach(card => {
                card.classList.remove('selected');
            });
            updateSubmitButton();
        });

        document.getElementById('customAnswerInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter' && !document.getElementById('submitAnswerBtn').disabled) {
                submitAnswer();
            }
        });

        // Initialize
        updateGameStatus('Welcome! Enter your name to join or create a game.');
    </script>
</body>
</html>
