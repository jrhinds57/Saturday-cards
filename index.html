<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Private Game Room</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #1a1a1a 0%, #2d2d2d 100%);
            color: #ffffff;
            min-height: 100vh;
            padding: 20px;
            display: flex;
        }

        .game-layout {
            display: flex;
            width: 100%;
            gap: 20px;
        }

        .scoreboard {
            width: 250px;
            flex-shrink: 0;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 20px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            height: fit-content;
            position: sticky;
            top: 20px;
        }

        .scoreboard h3 {
            text-align: center;
            color: #ff6b6b;
            margin-bottom: 15px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
            padding-bottom: 10px;
        }

        .score-player {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 12px;
            margin-bottom: 8px;
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.05);
            border-left: 3px solid transparent;
        }

        .score-player.host {
            border-left-color: #ff6b6b;
        }

        .score-player.czar {
            border-left-color: #ffd700;
            background: rgba(255, 215, 0, 0.1);
        }

        .score-player-name {
            font-weight: bold;
            font-size: 14px;
        }

        .score-player-points {
            color: #4ecdc4;
            font-weight: bold;
            font-size: 16px;
        }

        .main-content {
            flex: 1;
            min-width: 0;
        }

        .container {
            max-width: none;
            margin: 0;
            width: 100%;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            color: #ff6b6b;
        }

        .game-section {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 20px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .join-form {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .join-form input, .join-form button {
            padding: 12px 20px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
        }

        .join-form input {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.3);
            flex: 1;
            min-width: 200px;
        }

        .join-form input::placeholder {
            color: rgba(255, 255, 255, 0.7);
        }

        .btn {
            background: linear-gradient(135deg, #ff6b6b, #ee5a52);
            color: white;
            cursor: pointer;
            transition: all 0.3s ease;
            border: none;
            border-radius: 8px;
            padding: 12px 24px;
            font-size: 16px;
        }

        .btn:hover {
            background: linear-gradient(135deg, #ee5a52, #ff6b6b);
            transform: translateY(-2px);
        }

        .btn:disabled {
            background: #666;
            cursor: not-allowed;
            transform: none;
        }

        .btn-secondary {
            background: linear-gradient(135deg, #4ecdc4, #44a08d);
        }

        .btn-secondary:hover {
            background: linear-gradient(135deg, #44a08d, #4ecdc4);
        }

        .btn-small {
            padding: 8px 16px;
            font-size: 14px;
        }

        .game-info {
            text-align: center;
            margin-bottom: 20px;
            padding: 15px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
        }

        .game-code {
            font-size: 3rem;
            font-weight: bold;
            color: #4ecdc4;
            margin: 10px 0;
            letter-spacing: 8px;
            font-family: 'Courier New', monospace;
        }

        .players-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .player-card {
            background: rgba(255, 255, 255, 0.15);
            border-radius: 10px;
            padding: 15px;
            border: 2px solid transparent;
            transition: all 0.3s ease;
            position: relative;
        }

        .player-card.czar {
            border-color: #ffd700;
            background: rgba(255, 215, 0, 0.2);
        }

        .player-card.host {
            border-color: #ff6b6b;
        }

        .player-name {
            font-weight: bold;
            font-size: 18px;
            margin-bottom: 5px;
        }

        .player-score {
            color: #4ecdc4;
            font-size: 24px;
            font-weight: bold;
        }

        .hidden {
            display: none;
        }

        .game-status {
            text-align: center;
            font-size: 18px;
            margin-bottom: 20px;
            padding: 15px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
        }

        .success-message {
            background: rgba(40, 167, 69, 0.2);
            border: 1px solid #28a745;
            color: #28a745;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
            text-align: center;
        }

        .error-message {
            background: rgba(220, 53, 69, 0.2);
            border: 1px solid #dc3545;
            color: #dc3545;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
            text-align: center;
        }

        .actions {
            display: flex;
            gap: 15px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .card-customization {
            margin-bottom: 20px;
        }

        .card-customization h3 {
            text-align: center;
            color: #4ecdc4;
            margin-bottom: 15px;
        }

        .card-sections {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        .card-section {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
            padding: 15px;
        }

        .card-section h4 {
            color: #ff6b6b;
            margin-bottom: 10px;
            text-align: center;
        }

        .card-section textarea {
            width: 100%;
            height: 150px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 5px;
            color: white;
            padding: 10px;
            font-size: 14px;
            resize: vertical;
        }

        .card-section textarea::placeholder {
            color: rgba(255, 255, 255, 0.5);
        }

        .card-help {
            font-size: 12px;
            color: rgba(255, 255, 255, 0.7);
            margin-top: 5px;
        }

        .black-card {
            background: rgba(50, 50, 50, 0.8);
            border: 2px solid #444;
            border-radius: 10px;
            padding: 20px;
            margin: 10px 0;
            min-height: 100px;
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
            font-size: 18px;
            font-weight: bold;
        }

        .white-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
            margin: 20px 0;
        }

        .white-card {
            background: rgba(255, 255, 255, 0.9);
            color: #333;
            border-radius: 8px;
            padding: 15px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 2px solid transparent;
            min-height: 80px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
        }

        .white-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
        }

        .white-card.selected {
            border-color: #ff6b6b;
            background: rgba(255, 107, 107, 0.2);
            color: white;
        }

        .round-info {
            text-align: center;
            margin-bottom: 20px;
            padding: 15px;
            background: rgba(255, 215, 0, 0.1);
            border: 1px solid #ffd700;
            border-radius: 10px;
            color: #ffd700;
        }

        @media (max-width: 768px) {
            body {
                flex-direction: column;
            }
            
            .game-layout {
                flex-direction: column;
            }
            
            .scoreboard {
                width: 100%;
                position: static;
                order: -1;
            }
            
            .header h1 {
                font-size: 2rem;
            }
            
            .join-form {
                flex-direction: column;
            }
            
            .join-form input {
                min-width: auto;
            }

            .card-sections {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="game-layout">
        <!-- Scoreboard -->
        <div id="scoreboard" class="scoreboard hidden">
            <h3>🏆 Scoreboard</h3>
            <div id="scoreboardPlayers">
                <!-- Score list will be populated here -->
            </div>
        </div>

        <!-- Main Game Content -->
        <div class="main-content">
            <div class="container">
                <div class="header">
                    <h1>🎲 Private Game Room</h1>
                    <p>A card game for friends who aren't easily offended</p>
                </div>

                <!-- Start/Join Game Section -->
                <div id="mainSection" class="game-section">
                    <h2 style="text-align: center; margin-bottom: 20px;">Join or Create Game</h2>
                    <div class="join-form">
                        <input type="text" id="playerName" placeholder="Enter your name" maxlength="20">
                        <input type="text" id="gameCode" placeholder="Game code (leave empty to create)" maxlength="4">
                        <button class="btn" onclick="joinOrCreateGame()">Join/Create Game</button>
                    </div>
                </div>

                <!-- Game Info Section -->
                <div id="gameInfoSection" class="game-section hidden">
                    <div class="game-info">
                        <h3>Game Code:</h3>
                        <div class="game-code" id="displayGameCode"></div>
                        <p>Share this code with friends to let them join!</p>
                    </div>
                </div>

                <!-- Card Customization Section -->
                <div id="cardCustomization" class="game-section hidden">
                    <div class="card-customization">
                        <h3>📝 Customize Cards (Optional)</h3>
                        <div class="card-sections">
                            <div class="card-section">
                                <h4>Black Cards (Questions)</h4>
                                <textarea id="blackCardsInput" placeholder="Enter one card per line. Use ___ for blanks.&#10;Example:&#10;What's my secret power?&#10;___ + ___ = ___."></textarea>
                                <div class="card-help">One card per line. Use ___ for blanks that players fill in.</div>
                            </div>
                            <div class="card-section">
                                <h4>White Cards (Answers)</h4>
                                <textarea id="whiteCardsInput" placeholder="Enter one card per line.&#10;Example:&#10;A mime having a stroke&#10;My genitals&#10;Poor life choices"></textarea>
                                <div class="card-help">One card per line. These are the answer options for players.</div>
                            </div>
                        </div>
                        <div class="actions" style="margin-top: 15px;">
                            <button class="btn btn-secondary btn-small" onclick="loadDefaultCards()">Reset to Defaults</button>
                            <button class="btn btn-small" onclick="updateCards()">Update Cards</button>
                        </div>
                    </div>
                </div>

                <!-- Players List -->
                <div id="playersSection" class="game-section hidden">
                    <h2 style="text-align: center; margin-bottom: 20px;">Players</h2>
                    <div id="playersList" class="players-list">
                        <!-- Players will be populated here -->
                    </div>
                    <div id="hostControls" class="hidden">
                        <div class="actions" style="margin-top: 15px;">
                            <button class="btn btn-secondary" onclick="refreshGameData()">Refresh Player List</button>
                            <button class="btn" onclick="startGame()">Start Game</button>
                        </div>
                    </div>
                </div>

                <!-- Game Play Section -->
                <div id="gamePlaySection" class="game-section hidden">
                    <div id="roundInfo" class="round-info">
                        <h3>Round <span id="currentRound">1</span> of <span id="maxRounds">10</span></h3>
                        <p>Card Czar: <span id="currentCzar">Player Name</span></p>
                    </div>

                    <div id="blackCardDisplay" class="black-card">
                        <!-- Current black card will appear here -->
                    </div>

                    <div id="playerHand" class="white-cards">
                        <!-- Player's white cards will appear here -->
                    </div>

                    <div id="gameActions" class="actions">
                        <button id="submitCard" class="btn" onclick="submitCard()" disabled>Submit Selected Card</button>
                        <button class="btn btn-secondary" onclick="leaveGame()">Leave Game</button>
                    </div>
                </div>

                <!-- Game Status -->
                <div id="gameStatus" class="game-status hidden">
                    Waiting for game to start...
                </div>
            </div>
        </div>
    </div>

    <!-- Supabase SDK -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <script>
        // Supabase Configuration
        const supabaseUrl = 'https://krrrwuoehltojuzjizqf.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImtycnJ3dW9laGx0b2p1emppenFmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTkwMTc2MjcsImV4cCI6MjA3NDU5MzYyN30.t36l0IPV3k0WHWSLZbv1fA_nBerBP-t51e9qjzgzXrM';

        // Initialize Supabase with error checking
        let supabase;
        try {
            if (typeof window.supabase === 'undefined') {
                throw new Error('Supabase library not loaded');
            }
            supabase = window.supabase.createClient(supabaseUrl, supabaseKey);
        } catch (error) {
            console.error('Failed to initialize Supabase:', error);
            showMessage('Failed to load game library. Please refresh the page.', 'error');
        }

        // Game state
        let currentGame = null;
        let currentPlayer = {
            id: null,
            name: '',
            isHost: false,
            hand: [],
            selectedCard: null
        };

        // Default card decks
        const defaultBlackCards = [
            "___: kid tested, mother approved.",
            "___? There's an app for that.",
            "What's the next Happy Meal toy?",
            "In his new self-produced album, Kanye West raps over the sounds of ___.",
            "What ended my last relationship?",
            "I drink to forget ___.",
            "What's that sound?",
            "What's the most emo?",
            "Instead of coal, Santa now gives the bad children ___.",
            "What gives me uncontrollable gas?",
            "The Academy Award for ___ goes to ___.",
            "What's my secret power?",
            "___ + ___ = ___.",
            "In M. Night Shyamalan's new movie, Bruce Willis discovers that ___ had really been ___ all along.",
            "What's the new fad diet?",
            "What's there a ton of in heaven?",
            "Coming to Broadway this season, ___: The Musical.",
            "Alternative medicine is now embracing the curative powers of ___.",
            "What's Batman's guilty pleasure?",
            "TSA guidelines now prohibit ___ on airplanes."
        ];

        const defaultWhiteCards = [
            "A mime having a stroke",
            "The Big Bang",
            "Getting so angry you pop a boner",
            "Vigorous jazz hands",
            "A windmill full of corpses",
            "Swooping",
            "The invisible hand",
            "A sassy black woman",
            "Abstinence",
            "Adderall",
            "My genitals",
            "Racially-biased SAT questions",
            "The Three-Fifths compromise",
            "Take-backsies",
            "My collection of high-tech sex toys",
            "Throwing a virgin into a volcano",
            "Bling",
            "Poor life choices",
            "Powerful thighs",
            "The South",
            "Expecting a burp and vomiting on the floor",
            "Cheating in the Special Olympics",
            "My sex life",
            "Incest",
            "A can of whoop-ass",
            "Viagra",
            "Dead babies",
            "Switching to Geico",
            "Daniel Radcliffe's delicious asshole",
            "Erectile dysfunction"
        ];

        // Utility functions
        function generateId() {
            return Math.random().toString(36).substr(2, 9);
        }

        function generateGameCode() {
            return Math.floor(1000 + Math.random() * 9000).toString();
        }

        function shuffleArray(array) {
            const shuffled = [...array];
            for (let i = shuffled.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
            }
            return shuffled;
        }

        function getRandomCards(deck, count) {
            return shuffleArray(deck).slice(0, count);
        }

        function showMessage(message, type = 'success') {
            const messageDiv = document.createElement('div');
            messageDiv.className = type === 'success' ? 'success-message' : 'error-message';
            messageDiv.textContent = message;
            
            document.body.appendChild(messageDiv);
            
            setTimeout(() => {
                messageDiv.remove();
            }, 5000);
        }

        // UI Management
        function showSection(sectionId) {
            document.querySelectorAll('.game-section, #gameStatus').forEach(section => {
                section.classList.add('hidden');
            });
            const section = document.getElementById(sectionId);
            if (section) section.classList.remove('hidden');
        }

        function updateGameStatus(message) {
            const statusEl = document.getElementById('gameStatus');
            statusEl.textContent = message;
            statusEl.classList.remove('hidden');
        }

        function updatePlayersDisplay(gameData) {
            const playersList = document.getElementById('playersList');
            playersList.innerHTML = '';

            if (!gameData.players) return;

            Object.values(gameData.players).forEach(player => {
                const playerDiv = document.createElement('div');
                playerDiv.className = 'player-card';
                
                if (player.id === gameData.host_id) {
                    playerDiv.classList.add('host');
                }

                if (gameData.current_czar === player.id) {
                    playerDiv.classList.add('czar');
                }

                playerDiv.innerHTML = `
                    <div class="player-name">
                        ${player.name}
                        ${player.id === gameData.host_id ? ' 👑' : ''}
                        ${gameData.current_czar === player.id ? ' 🎭' : ''}
                    </div>
                    <div class="player-score">Score: ${player.score || 0}</div>
                `;
                playersList.appendChild(playerDiv);
            });

            // Update scoreboard
            updateScoreboard(gameData);
        }

        function updateScoreboard(gameData) {
            const scoreboardContainer = document.getElementById('scoreboardPlayers');
            const scoreboard = document.getElementById('scoreboard');
            
            if (!gameData.players || gameData.phase === 'waiting') {
                scoreboard.classList.add('hidden');
                return;
            }

            // Show scoreboard during gameplay
            scoreboard.classList.remove('hidden');

            // Sort players by score (highest first)
            const sortedPlayers = Object.values(gameData.players).sort((a, b) => (b.score || 0) - (a.score || 0));

            scoreboardContainer.innerHTML = '';
            sortedPlayers.forEach((player, index) => {
                const scoreDiv = document.createElement('div');
                scoreDiv.className = 'score-player';
                
                if (player.id === gameData.host_id) {
                    scoreDiv.classList.add('host');
                }

                if (gameData.current_czar === player.id) {
                    scoreDiv.classList.add('czar');
                }

                // Add rank indicator for top 3
                let rankIndicator = '';
                if (index === 0 && player.score > 0) rankIndicator = '🥇';
                else if (index === 1 && player.score > 0) rankIndicator = '🥈';
                else if (index === 2 && player.score > 0) rankIndicator = '🥉';

                scoreDiv.innerHTML = `
                    <div class="score-player-name">
                        ${rankIndicator} ${player.name}
                        ${player.id === gameData.host_id ? ' 👑' : ''}
                        ${gameData.current_czar === player.id ? ' 🎭' : ''}
                    </div>
                    <div class="score-player-points">${player.score || 0}</div>
                `;
                scoreboardContainer.appendChild(scoreDiv);
            });
        }

        // Card Management
        function loadDefaultCards() {
            document.getElementById('blackCardsInput').value = defaultBlackCards.join('\n');
            document.getElementById('whiteCardsInput').value = defaultWhiteCards.join('\n');
            showMessage('Default cards loaded!');
        }

        async function updateCards() {
            if (!currentPlayer.isHost || !currentGame) {
                showMessage('Only the host can update cards', 'error');
                return;
            }

            const blackCardsText = document.getElementById('blackCardsInput').value.trim();
            const whiteCardsText = document.getElementById('whiteCardsInput').value.trim();

            let blackCards = defaultBlackCards;
            let whiteCards = defaultWhiteCards;

            if (blackCardsText) {
                blackCards = blackCardsText.split('\n').filter(card => card.trim()).map(card => card.trim());
            }

            if (whiteCardsText) {
                whiteCards = whiteCardsText.split('\n').filter(card => card.trim()).map(card => card.trim());
            }

            if (blackCards.length < 10) {
                showMessage('Need at least 10 black cards', 'error');
                return;
            }

            if (whiteCards.length < 50) {
                showMessage('Need at least 50 white cards', 'error');
                return;
            }

            try {
                const { error } = await supabase
                    .from('games')
                    .update({
                        black_cards: blackCards,
                        white_cards: whiteCards
                    })
                    .eq('code', currentGame);

                if (error) throw error;

                showMessage('Cards updated successfully!');
            } catch (error) {
                console.error('Error updating cards:', error);
                showMessage('Error updating cards: ' + error.message, 'error');
            }
        }

        // Game Logic
        async function joinOrCreateGame() {
            const nameInput = document.getElementById('playerName');
            const codeInput = document.getElementById('gameCode');
            const name = nameInput.value.trim();
            const code = codeInput.value.trim();

            if (!name) {
                showMessage('Please enter your name', 'error');
                return;
            }

            // Validate 4-digit code if provided
            if (code && (!/^\d{4}$/.test(code))) {
                showMessage('Game code must be exactly 4 digits', 'error');
                return;
            }

            currentPlayer.name = name;
            currentPlayer.id = generateId();

            if (code) {
                await joinGame(code);
            } else {
                await createGame();
            }
        }

        async function createGame() {
            const gameCode = generateGameCode();
            currentPlayer.isHost = true;

            const gameData = {
                code: gameCode,
                host_id: currentPlayer.id,
                phase: 'waiting',
                players: {
                    [currentPlayer.id]: {
                        id: currentPlayer.id,
                        name: currentPlayer.name,
                        score: 0,
                        hand: []
                    }
                },
                black_cards: defaultBlackCards,
                white_cards: defaultWhiteCards,
                round: 0,
                max_rounds: 10,
                current_black_card: null,
                current_czar: null,
                submitted_cards: {},
                created_at: new Date().toISOString()
            };

            try {
                const { error } = await supabase
                    .from('games')
                    .insert([gameData]);

                if (error) throw error;

                currentGame = gameCode;
                setupGameListener(gameCode);
                showGameLobby(gameCode);
                showMessage('Game created successfully!');
            } catch (error) {
                console.error('Error creating game:', error);
                showMessage('Error creating game: ' + error.message, 'error');
            }
        }

        async function joinGame(gameCode) {
            try {
                const { data: gameData, error } = await supabase
                    .from('games')
                    .select('*')
                    .eq('code', gameCode)
                    .single();

                if (error || !gameData) {
                    showMessage('Game not found. Please check the code.', 'error');
                    return;
                }

                if (gameData.phase !== 'waiting') {
                    // Check if this player was already in the game (reconnection)
                    const existingPlayer = Object.values(gameData.players || {}).find(
                        player => player.name === currentPlayer.name
                    );
                    
                    if (existingPlayer) {
                        // Reconnect with same ID and score
                        currentPlayer.id = existingPlayer.id;
                        currentPlayer.hand = existingPlayer.hand || [];
                        currentGame = gameCode;
                        setupGameListener(gameCode);
                        showMessage('Reconnected to game!');
                        return;
                    } else {
                        showMessage('This game has already started and you were not a participant.', 'error');
                        return;
                    }
                }

                // Add player to game
                const updatedPlayers = {
                    ...gameData.players,
                    [currentPlayer.id]: {
                        id: currentPlayer.id,
                        name: currentPlayer.name,
                        score: 0,
                        hand: []
                    }
                };

                const { error: updateError } = await supabase
                    .from('games')
                    .update({ players: updatedPlayers })
                    .eq('code', gameCode);

                if (updateError) throw updateError;

                currentGame = gameCode;
                setupGameListener(gameCode);
                showGameLobby(gameCode);
                showMessage('Joined game successfully!');
            } catch (error) {
                console.error('Error joining game:', error);
                showMessage('Error joining game: ' + error.message, 'error');
            }
        }

        function setupGameListener(gameCode) {
            console.log('Setting up game listener for code:', gameCode);
            
            // Subscribe to real-time updates
            const subscription = supabase
                .channel(`game-${gameCode}`)
                .on('postgres_changes',
                    {
                        event: '*',
                        schema: 'public',
                        table: 'games',
                        filter: `code=eq.${gameCode}`
                    },
                    (payload) => {
                        console.log('Real-time update received:', payload);
                        if (payload.new) {
                            updateGameDisplay(payload.new);
                        }
                    }
                )
                .subscribe((status) => {
                    console.log('Subscription status:', status);
                });

            // Also do periodic polling as backup
            const pollInterval = setInterval(async () => {
                await loadGameData(gameCode);
            }, 3000);

            // Store cleanup function
            window.gameCleanup = () => {
                clearInterval(pollInterval);
                supabase.removeChannel(subscription);
            };

            // Initial load
            loadGameData(gameCode);
        }

        async function loadGameData(gameCode) {
            try {
                const { data: gameData, error } = await supabase
                    .from('games')
                    .select('*')
                    .eq('code', gameCode)
                    .single();

                if (error || !gameData) {
                    console.error('Error loading game data:', error);
                    return;
                }

                updateGameDisplay(gameData);
            } catch (error) {
                console.error('Error loading game data:', error);
            }
        }

        function updateGameDisplay(gameData) {
            updatePlayersDisplay(gameData);

            switch (gameData.phase) {
                case 'waiting':
                    showWaitingPhase(gameData);
                    break;
                case 'playing':
                    showPlayingPhase(gameData);
                    break;
                case 'round_end':
                    showRoundEndPhase(gameData);
                    break;
                case 'game_end':
                    showGameEndPhase(gameData);
                    break;
                default:
                    updateGameStatus('Game in progress...');
                    break;
            }
        }

        function showGameLobby(gameCode) {
            document.getElementById('displayGameCode').textContent = gameCode;
            document.getElementById('mainSection').classList.add('hidden');
            document.getElementById('gameInfoSection').classList.remove('hidden');
            document.getElementById('playersSection').classList.remove('hidden');
            
            if (currentPlayer.isHost) {
                document.getElementById('hostControls').classList.remove('hidden');
                document.getElementById('cardCustomization').classList.remove('hidden');
                loadDefaultCards();
            }
        }

        function showWaitingPhase(gameData) {
            updateGameStatus('Waiting for players to join...');
            document.getElementById('gamePlaySection').classList.add('hidden');
        }

        function showPlayingPhase(gameData) {
            document.getElementById('gameInfoSection').classList.add('hidden');
            document.getElementById('playersSection').classList.add('hidden');
            document.getElementById('cardCustomization').classList.add('hidden');
            document.getElementById('gameStatus').classList.add('hidden');
            document.getElementById('gamePlaySection').classList.remove('hidden');

            // Update round info
            document.getElementById('currentRound').textContent = gameData.round || 1;
            document.getElementById('maxRounds').textContent = gameData.max_rounds || 10;
            
            const czarPlayer = Object.values(gameData.players).find(p => p.id === gameData.current_czar);
            document.getElementById('currentCzar').textContent = czarPlayer ? czarPlayer.name : 'Unknown';

            // Update black card
            document.getElementById('blackCardDisplay').textContent = gameData.current_black_card || 'Loading...';

            // Update player's hand if they're not the czar
            updatePlayerHand(gameData);
        }

        function updatePlayerHand(gameData) {
            const playerHandDiv = document.getElementById('playerHand');
            const submitButton = document.getElementById('submitCard');
            
            // If this player is the czar, hide their hand
            if (gameData.current_czar === currentPlayer.id) {
                playerHandDiv.innerHTML = '<div style="text-align: center; padding: 20px; color: #ffd700;">You are the Card Czar! Wait for players to submit their cards.</div>';
                submitButton.style.display = 'none';
                return;
            }

            submitButton.style.display = 'inline-block';

            // Get current player's hand
            const player = gameData.players[currentPlayer.id];
            const hand = player?.hand || [];

            if (hand.length === 0) {
                playerHandDiv.innerHTML = '<div style="text-align: center; padding: 20px;">Loading your cards...</div>';
                return;
            }

            playerHandDiv.innerHTML = '';
            hand.forEach((card, index) => {
                const cardDiv = document.createElement('div');
                cardDiv.className = 'white-card';
                cardDiv.textContent = card;
                cardDiv.onclick = () => selectCard(index, card);
                
                if (currentPlayer.selectedCard === index) {
                    cardDiv.classList.add('selected');
                }
                
                playerHandDiv.appendChild(cardDiv);
            });

            // Update submit button
            submitButton.disabled = currentPlayer.selectedCard === null;
        }

        function selectCard(index, card) {
            // Remove previous selection
            document.querySelectorAll('.white-card').forEach(c => c.classList.remove('selected'));
            
            // Add selection to clicked card
            event.target.classList.add('selected');
            currentPlayer.selectedCard = index;
            
            // Enable submit button
            document.getElementById('submitCard').disabled = false;
        }

        async function submitCard() {
            if (currentPlayer.selectedCard === null) return;

            try {
                const { data: gameData, error: fetchError } = await supabase
                    .from('games')
                    .select('*')
                    .eq('code', currentGame)
                    .single();

                if (fetchError) throw fetchError;

                const player = gameData.players[currentPlayer.id];
                const selectedCardText = player.hand[currentPlayer.selectedCard];

                // Add submission to game data
                const updatedSubmissions = {
                    ...gameData.submitted_cards,
                    [currentPlayer.id]: selectedCardText
                };

                // Remove card from player's hand
                const updatedHand = [...player.hand];
                updatedHand.splice(currentPlayer.selectedCard, 1);

                const updatedPlayers = {
                    ...gameData.players,
                    [currentPlayer.id]: {
                        ...player,
                        hand: updatedHand
                    }
                };

                const { error: updateError } = await supabase
                    .from('games')
                    .update({
                        submitted_cards: updatedSubmissions,
                        players: updatedPlayers
                    })
                    .eq('code', currentGame);

                if (updateError) throw updateError;

                currentPlayer.selectedCard = null;
                showMessage('Card submitted!');

            } catch (error) {
                console.error('Error submitting card:', error);
                showMessage('Error submitting card: ' + error.message, 'error');
            }
        }

        function showRoundEndPhase(gameData) {
            updateGameStatus('Round ended! Preparing next round...');
        }

        function showGameEndPhase(gameData) {
            updateGameStatus('Game finished! Thanks for playing!');
        }

        async function refreshGameData() {
            if (!currentGame) return;
            console.log('Manually refreshing game data for:', currentGame);
            await loadGameData(currentGame);
            showMessage('Game data refreshed!');
        }

        async function startGame() {
            if (!currentPlayer.isHost) return;

            try {
                const { data: gameData, error: fetchError } = await supabase
                    .from('games')
                    .select('*')
                    .eq('code', currentGame)
                    .single();

                if (fetchError) throw fetchError;

                const playerCount = Object.keys(gameData.players).length;

                if (playerCount < 3) {
                    showMessage('Need at least 3 players to start', 'error');
                    return;
                }

                // Pick first czar (host)
                const playerIds = Object.keys(gameData.players);
                const firstCzar = gameData.host_id;

                // Deal initial hands
                const updatedPlayers = { ...gameData.players };
                const whiteCards = [...gameData.white_cards];
                let cardIndex = 0;

                Object.keys(updatedPlayers).forEach(playerId => {
                    const hand = [];
                    for (let i = 0; i < 7; i++) {
                        if (cardIndex < whiteCards.length) {
                            hand.push(whiteCards[cardIndex]);
                            cardIndex++;
                        }
                    }
                    updatedPlayers[playerId].hand = hand;
                });

                // Pick first black card
                const firstBlackCard = gameData.black_cards[0];

                const { error: updateError } = await supabase
                    .from('games')
                    .update({
                        phase: 'playing',
                        round: 1,
                        current_czar: firstCzar,
                        current_black_card: firstBlackCard,
                        players: updatedPlayers,
                        submitted_cards: {}
                    })
                    .eq('code', currentGame);

                if (updateError) throw updateError;

                showMessage('Game started!');
            } catch (error) {
                console.error('Error starting game:', error);
                showMessage('Error starting game: ' + error.message, 'error');
            }
        }

        async function leaveGame() {
            if (confirm('Are you sure you want to leave the game?')) {
                if (window.gameCleanup) {
                    window.gameCleanup();
                }
                location.reload();
            }
        }

        // Initialize the app
        async function initializeApp() {
            try {
                // Test Supabase connection
                const { data, error } = await supabase.from('games').select('count').limit(1);
                
                if (error) {
                    console.error('Supabase connection error:', error);
                    showMessage('Database connection failed. Please refresh the page.', 'error');
                } else {
                    console.log('Supabase connected successfully');
                    updateGameStatus('Welcome! Enter your name to join or create a game.');
                }
            } catch (error) {
                console.error('Initialization error:', error);
                showMessage('Failed to initialize game. Please refresh the page.', 'error');
            }
        }

        // Event Listeners
        document.getElementById('playerName').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                joinOrCreateGame();
            }
        });

        document.getElementById('gameCode').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                joinOrCreateGame();
            }
        });

        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', function() {
            // Make functions globally accessible
            window.joinOrCreateGame = joinOrCreateGame;
            window.startGame = startGame;
            window.refreshGameData = refreshGameData;
            window.loadDefaultCards = loadDefaultCards;
            window.updateCards = updateCards;
            window.submitCard = submitCard;
            window.leaveGame = leaveGame;
            
            initializeApp();
        });
    </script>
</body>
</html>
